function init(){$("#loading-bar").toggleClass("-action"),$.ajax({url:"api.php",cache:!1,dataType:"json",type:"GET",data:{calling:"log",action:"history_log",device_id:device_id,time_stamp:time_lastupdate,limit:limit},error:function(){console.log("Request Error"),$("#disconnect-bar").addClass("-active"),setTimeout(function(){myChart.destroy(),init()},1e4)}}).done(function(e){var t=e.data.items,i=[],a=[],n=[];$.each(t,function(e,t){i.push(t.log_temp),a.push(t.log_time),n.push(t.log_timestamp)}),deviceDisconnect(n[0],e.data.update),console.log(a,i,n),graphRender(i.reverse(),a.reverse()),historyRender(t),renderCurrent(e.data.device_log),setTimeout(function(){myChart.destroy(),init()},1e4)}).error()}function deviceDisconnect(e,t){console.log(t,e,t-e),$disconnect=$("#disconnect-bar");var i=t-e;i>300?$disconnect.addClass("-active"):$disconnect.removeClass("-active")}function renderCurrent(e){var t=$("#site_title").val(),i=$("#device_name").val();document.title=e.current.temp+"° | "+i+" | "+t,$("#tempcurrent").html(e.current.temp+"°"),$("#timecurrent").html(e.current.time),$("#templowest").html(e.min.temp+"°"),$("#timelowest").html(e.min.time),$("#temphighest").html(e.max.temp+"°"),$("#timehighest").html(e.max.time)}function limitChecking(e){var t=e[e.length-1];if(t>=device_max||device_min>=t){var i=["#e74c3c","#451612"];return i}var i=["#21ce99","#093d2d"];return i}function graphRender(e,t){$("#graph").html("");var i=limitChecking(e),a=document.getElementById("graph").getContext("2d");myChart=new Chart(a,{type:"line",data:{labels:t,datasets:[{data:e,backgroundColor:i[1],borderColor:i[0],fill:"origin",pointRadius:1}]},options:{responsive:!0,maintainAspectRatio:!1,tooltips:{callbacks:{label:function(e){return e.yLabel}}},title:{display:!1},legend:{display:!1},scales:{yAxes:[{ticks:{stepSize:.5},position:"right"}],xAxes:[{display:!1}]},animation:{duration:0},hover:{animationDuration:0},responsiveAnimationDuration:0}})}function historyRender(e){var t="",i=new Array;return 0==e.length?($("#historylog").html('<div class="empty">ไม่มีข้อมูลของอุปกรณ์นี้</div>'),!1):($.each(e,function(e,a){i.push(parseFloat(a.log_temp));var n="",o="";switch(a.log_state){case"up":o='<i class="far fa-arrow-up"></i>';break;case"down":o='<i class="far fa-arrow-down"></i>'}a.alert&&(n='<i class="far fa-exclamation-triangle"></i>'),t+='<div class="logitems">',t+='<div class="id">#'+a.log_id+n+"</div>",t+='<div class="time">'+a.log_time_fb+"</div>",t+='<div class="temp">'+a.log_temp+"°</div>",t+='<div class="icon">'+o+"</div>",t+="</div>"}),$("#historylog").html(t),void 0)}var time_lastupdate=0,loop_lost=0,device_min=0,device_max=0,device_od,myChart,limit=10,disconnect_time=300;Chart.defaults.global.defaultFontColor="#586468",Chart.defaults.global.defaultFontSize="10",$(document).ready(function(){device_min=parseInt($("#device_min").val()),device_max=parseInt($("#device_max").val()),device_id=$("#device_id").val(),init()});